import useSWR from 'swr'
import Head from 'next/head'
import Layout from '../components/layout'
import Upload from '../components/upload'
import TdNum from '../components/td-num'
import * as format from '../utils/format'


export default function Import() {

  const fetcher = (...args) => fetch(...args).then(res => res.json())
  const { data, error } = useSWR('/api/yield-transfer', fetcher)

  let transfers
  if (error) {
    transfers = <div className="text-center pt-4">Failed to load data!</div>
  }
  else if (!data) {
    transfers = <div className="text-center pt-4">Loading data…</div>
  }
  else if (Object.keys(data.transfers).length == 0) {
    transfers = <div className="text-center pt-4">No yield transfers imported</div>
  }
  else {
    transfers =
      Object.keys(data.transfers).map(asset =>
        Object.keys(data.transfers[asset]).map(account =>
          <table key={`${asset}-${account}`} className="w-full">
            <caption>{asset} — {account}</caption>
            <thead>
              <tr>
                <th>Completion date</th>
                <th className="text-right">Amount</th>
              </tr>
            </thead>
            <tbody>
              {data.transfers[asset][account].map(transfer =>
                <tr key={transfer.completionDate}>
                  <td className="tabular-nums">{format.asDateTime(transfer.completionDate)}</td>
                  <TdNum currency={asset}>{transfer.amount}</TdNum>
                </tr>
              )}
            </tbody>
          </table>
        )
      )
  }

  return (
    <Layout name="Import">
      <Head>
        <title>Import Files</title>
      </Head>
      <div className="space-y-5">
        <div>
          <h2>Account Statement</h2>
          <p>Generate your account statement using the SwissBorg app (Excel file) and upload it here.</p>
          <Upload name="account-statement" url="/api/import-file" />
        </div>

        <div>
          <h2>Smart Yield Transfers</h2>
          <p>
            Smart Yield transfers amounts (subscriptions & redemptions) are not available in the account statement generated by SwissBorg.
            Thus, it is necessary to upload them with a separate Excel file.</p>
          <Upload name="yield-transfers" url="/api/import-file" />
        </div>

        <div>
          <h2>Imported Transfers</h2>
          <div className="grid grid-cols-3 gap-8">
            {transfers}
          </div>
        </div>
      </div>
    </Layout>
  )
}
